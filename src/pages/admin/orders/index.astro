---
import DashboardLayout from '../../../layouts/DashboardLayout.astro';
import { getConvexClient } from '../../../lib/convex';
import { api } from '../../../../convex/_generated/api';

const orders = await getConvexClient().query(api.orders.listOrders, {});

function formatDate(ms: number): string {
  return new Date(ms).toLocaleDateString('en-US', {
    year: 'numeric', month: 'short', day: 'numeric',
  });
}

function formatCents(cents: number): string {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
  }).format(cents / 100);
}

function orderTotal(lineItems?: { totalAmount: number }[]): string {
  if (!lineItems || lineItems.length === 0) return 'â€”';
  const sum = lineItems.reduce((acc, item) => acc + item.totalAmount, 0);
  return formatCents(sum);
}

const statusColor: Record<string, string> = {
  paid:                  'bg-green-500/20 text-green-400',
  dropped_off:           'bg-blue-500/20 text-blue-400',
  picked_up:             'bg-cyan-500/20 text-cyan-400',
  stringing:             'bg-yellow-500/20 text-yellow-400',
  strung:                'bg-amber-500/20 text-amber-400',
  ready_for_pickup:      'bg-purple-500/20 text-purple-400',
  picked_up_by_customer: 'bg-teal-500/20 text-teal-400',
  review:                'bg-pink-500/20 text-pink-400',
  completed:             'bg-slate-500/20 text-slate-300',
};
---

<DashboardLayout
  title="RL Strings | Admin Dashboard - Orders"
  activePage="Orders"
  description="Orders Dashboard"
>
  <div class="mx-auto max-w-7xl px-3 py-8 sm:px-4 sm:py-16 lg:px-8">
    <h2 class="text-xl sm:text-2xl font-bold tracking-tight text-white">Orders</h2>

    {orders.length === 0 ? (
      <p class="mt-6 text-slate-400">No orders found.</p>
    ) : (
      <>
      {/* Mobile cards */}
      <div class="mt-6 flex flex-col gap-3 md:hidden">
        {orders.map((order) => (
          <a href={`/admin/orders/${order.pickupCode}`} class="block rounded-lg bg-slate-800/50 ring-1 ring-slate-700 p-4 space-y-2 hover:bg-slate-800/70 transition-colors">
            <div class="flex items-center justify-between">
              <span class="text-xs text-slate-400">{formatDate(order._creationTime)}</span>
              <span class={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${statusColor[order.status] ?? 'bg-slate-700 text-slate-300'}`}>
                {order.status.replace(/_/g, ' ')}
              </span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm font-medium text-slate-200">{order.customerName}</span>
              <span class="text-sm font-medium text-white">{orderTotal(order.lineItems)}</span>
            </div>
            <p class="text-xs text-slate-400 truncate">{order.email}</p>
            <p class="text-sm text-slate-300 line-clamp-2">{order.itemDescription}</p>
            {order.pickupCode && (
              <div class="flex items-center justify-between pt-1 border-t border-slate-700">
                <span class="text-xs text-slate-500">Pickup</span>
                <span class="text-xs font-mono text-slate-200">{order.pickupCode}</span>
              </div>
            )}
          </a>
        ))}
      </div>
      {/* Desktop table */}
      <div class="mt-6 hidden md:block overflow-x-auto rounded-lg ring-1 ring-slate-700">
        <table class="min-w-full divide-y divide-slate-700">
          <thead class="bg-slate-800">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-400">Date</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-400">Customer</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-400">Email</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-400">Description</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-400">Status</th>
              <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-slate-400">Pickup Code</th>
              <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-slate-400">Total</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-800 bg-slate-900">
            {orders.map((order) => (
              <tr class="hover:bg-slate-800/50 transition-colors cursor-pointer" onclick={`window.location='/admin/orders/${order.pickupCode}'`}>
                <td class="whitespace-nowrap px-4 py-3 text-sm text-slate-300">{formatDate(order._creationTime)}</td>
                <td class="px-4 py-3 text-sm text-slate-200">{order.customerName}</td>
                <td class="px-4 py-3 text-sm text-slate-400">{order.email}</td>
                <td class="px-4 py-3 text-sm text-slate-200">{order.itemDescription}</td>
                <td class="whitespace-nowrap px-4 py-3">
                  <span class={`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ${statusColor[order.status] ?? 'bg-slate-700 text-slate-300'}`}>
                    {order.status.replace(/_/g, ' ')}
                  </span>
                </td>
                <td class="whitespace-nowrap px-4 py-3 text-sm font-mono text-slate-200">{order.pickupCode}</td>
                <td class="whitespace-nowrap px-4 py-3 text-right text-sm font-medium text-white">
                  {orderTotal(order.lineItems)}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
      </>
    )}
  </div>
</DashboardLayout>
