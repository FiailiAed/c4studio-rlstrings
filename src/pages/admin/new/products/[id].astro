---
import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { ConvexHttpClient } from 'convex/browser';
import { api } from '../../../../../convex/_generated/api';
import type { Id } from '../../../../../convex/_generated/dataModel';

const auth = Astro.locals.auth();
const { userId } = auth;
if (!userId) return Astro.redirect('/admin/sign-in');

const { id } = Astro.params;
if (!id) return Astro.redirect('/admin/new/products');

const client = new ConvexHttpClient(import.meta.env.PUBLIC_CONVEX_URL);

const [product, allOrders] = await Promise.all([
  client.query(api.inventory.getItemById, { id: id as Id<'inventory'> }),
  client.query(api.orders.listOrders),
]);

if (!product) return Astro.redirect('/admin/new/products');

// Filter orders that contain this product's priceId
const relatedOrders = allOrders.filter((o) =>
  o.lineItems?.some((li) => li.priceId === product.priceId),
);

const CATEGORY_LABELS: Record<string, string> = {
  head: 'Heads', shaft: 'Shafts', mesh: 'Mesh',
  strings: 'Strings', service: 'Services', upsell: 'Upsells',
};
const CATEGORY_COLORS: Record<string, string> = {
  head: 'bg-blue-500/20 text-blue-300',
  shaft: 'bg-purple-500/20 text-purple-300',
  mesh: 'bg-green-500/20 text-green-300',
  strings: 'bg-amber-500/20 text-amber-300',
  service: 'bg-indigo-500/20 text-indigo-300',
  upsell: 'bg-pink-500/20 text-pink-300',
};
const STATUS_COLORS: Record<string, string> = {
  paid: 'bg-blue-500/20 text-blue-300 ring-1 ring-blue-500/30',
  dropped_off: 'bg-yellow-500/20 text-yellow-300 ring-1 ring-yellow-500/30',
  stringing: 'bg-purple-500/20 text-purple-300 ring-1 ring-purple-500/30',
  strung: 'bg-indigo-500/20 text-indigo-300 ring-1 ring-indigo-500/30',
  ready_for_pickup: 'bg-green-500/20 text-green-300 ring-1 ring-green-500/30',
  picked_up_by_customer: 'bg-teal-500/20 text-teal-300 ring-1 ring-teal-500/30',
  review: 'bg-amber-500/20 text-amber-300 ring-1 ring-amber-500/30',
  completed: 'bg-gray-500/20 text-gray-400 ring-1 ring-gray-500/30',
};

function formatCents(cents?: number | null) {
  if (cents == null) return '—';
  return `$${(cents / 100).toFixed(2)}`;
}
function formatDate(ts?: number | null) {
  if (!ts) return '—';
  return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function statusLabel(s: string) { return s.replace(/_/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase()); }
function statusColor(s: string) { return STATUS_COLORS[s] ?? 'bg-gray-500/20 text-gray-400 ring-1 ring-gray-500/30'; }
---

<AdminLayout
  title={`${product.name} | RL Strings Admin`}
  description="Product detail view."
  activePage="Inventory"
  pageTitle={product.name}
>
  <!-- Back link -->
  <div class="mb-6">
    <a href="/admin/new/products" class="inline-flex items-center gap-1.5 text-sm text-gray-400 hover:text-white transition-colors">
      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M10.5 19.5 3 12m0 0 7.5-7.5M3 12h18" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      All Products
    </a>
  </div>

  <div class="space-y-6">
    <!-- Product Info -->
    <div class="rounded-lg bg-gray-800 p-6 ring-1 ring-white/10">
      <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
        <div class="space-y-3">
          <div class="flex items-center gap-3">
            <h2 class="text-lg font-semibold text-white">{product.name}</h2>
            <span class={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium capitalize ${CATEGORY_COLORS[product.category] ?? 'bg-gray-500/20 text-gray-400'}`}>
              {product.category}
            </span>
          </div>
          <div class="grid grid-cols-2 gap-x-8 gap-y-1.5 text-sm">
            <span class="text-gray-500">Price</span>
            <span class="text-white font-medium">{formatCents(product.unitAmount)}</span>
            <span class="text-gray-500">Currency</span>
            <span class="text-gray-300 uppercase">{product.currency ?? 'USD'}</span>
            <span class="text-gray-500">Price Type</span>
            <span class="text-gray-300 capitalize">{product.priceType?.replace('_', ' ') ?? 'One Time'}</span>
          </div>
          {product.description && (
            <p class="text-sm text-gray-400 leading-relaxed max-w-md">{product.description}</p>
          )}
          {product.images && product.images.length > 0 && (
            <div class="flex gap-2 mt-2">
              {product.images.map((src) => (
                <img src={src} alt="" class="h-16 w-16 rounded-md object-cover ring-1 ring-white/10" />
              ))}
            </div>
          )}
        </div>

        <!-- Actions -->
        <div class="flex gap-2 shrink-0">
          <button
            onclick="document.getElementById('dialog-edit').showModal()"
            class="rounded-md bg-white/10 px-4 py-2 text-sm font-medium text-white hover:bg-white/20 transition-colors"
          >
            Edit
          </button>
          <button
            onclick={`confirmArchive('${product._id}', '${product.stripeProductId ?? ''}', ${JSON.stringify(product.name)})`}
            class="rounded-md bg-red-500/20 px-4 py-2 text-sm font-medium text-red-400 hover:bg-red-500/30 transition-colors"
          >
            Archive
          </button>
        </div>
      </div>
    </div>

    <!-- Stripe IDs -->
    <div class="rounded-lg bg-gray-800 p-6 ring-1 ring-white/10">
      <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-4">Stripe IDs</h3>
      <div class="space-y-2">
        <div class="flex items-center justify-between gap-4">
          <span class="text-sm text-gray-500 shrink-0">Product ID</span>
          <code class="text-xs text-gray-300 font-mono bg-gray-900/60 px-2 py-1 rounded">{product.stripeProductId ?? '—'}</code>
        </div>
        <div class="flex items-center justify-between gap-4">
          <span class="text-sm text-gray-500 shrink-0">Price ID</span>
          <code class="text-xs text-gray-300 font-mono bg-gray-900/60 px-2 py-1 rounded">{product.priceId}</code>
        </div>
      </div>
    </div>

    <!-- Visibility + Stock -->
    <div class="rounded-lg bg-gray-800 p-6 ring-1 ring-white/10">
      <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider mb-4">Visibility & Stock</h3>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div class="rounded-md bg-gray-900/50 px-4 py-3 text-center">
          <p class="text-xs text-gray-500 mb-1">Shop</p>
          <p class={`text-sm font-medium ${product.showInShop ? 'text-green-400' : 'text-gray-600'}`}>
            {product.showInShop ? 'Visible' : 'Hidden'}
          </p>
        </div>
        <div class="rounded-md bg-gray-900/50 px-4 py-3 text-center">
          <p class="text-xs text-gray-500 mb-1">Builder</p>
          <p class={`text-sm font-medium ${product.showInBuilder ? 'text-green-400' : 'text-gray-600'}`}>
            {product.showInBuilder ? 'Visible' : 'Hidden'}
          </p>
        </div>
        <div class="rounded-md bg-gray-900/50 px-4 py-3 text-center">
          <p class="text-xs text-gray-500 mb-1">Player Type</p>
          <p class="text-sm font-medium text-gray-300 capitalize">{product.playerType ?? '—'}</p>
        </div>
        <div class="rounded-md bg-gray-900/50 px-4 py-3 text-center">
          <p class="text-xs text-gray-500 mb-1">Stock</p>
          <p class={`text-sm font-semibold ${product.stock <= 0 ? 'text-red-400' : 'text-white'}`}>{product.stock}</p>
        </div>
      </div>
    </div>

    <!-- Related Orders -->
    <div class="rounded-lg bg-gray-800 ring-1 ring-white/10 overflow-hidden">
      <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
        <h3 class="text-sm font-medium text-gray-400 uppercase tracking-wider">Orders</h3>
        <span class="text-xs text-gray-600">{relatedOrders.length} order{relatedOrders.length !== 1 ? 's' : ''}</span>
      </div>

      {relatedOrders.length === 0 ? (
        <div class="px-6 py-12 text-center">
          <p class="text-sm text-gray-600">No orders contain this product.</p>
        </div>
      ) : (
        <table class="min-w-full divide-y divide-white/5">
          <thead>
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order #</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-white/5">
            {relatedOrders.map((order) => {
              const matchedItem = order.lineItems?.find((li) => li.priceId === product.priceId);
              return (
                <tr class="hover:bg-white/5 transition-colors">
                  <td class="px-6 py-3">
                    <a href={`/admin/new/orders/${order._id}`} class="text-sm font-mono font-medium text-white hover:text-gray-300 transition-colors">
                      #{order.pickupCode}
                    </a>
                  </td>
                  <td class="px-6 py-3 text-sm text-gray-300">{order.customerName}</td>
                  <td class="px-6 py-3 text-sm text-gray-300 text-right">{matchedItem?.quantity ?? 1}</td>
                  <td class="px-6 py-3">
                    <span class={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${statusColor(order.status)}`}>
                      {statusLabel(order.status)}
                    </span>
                  </td>
                  <td class="px-6 py-3 text-xs text-gray-500 text-right">{formatDate(order._creationTime)}</td>
                </tr>
              );
            })}
          </tbody>
        </table>
      )}
    </div>
  </div>

  <!-- Edit Dialog -->
  <dialog
    id="dialog-edit"
    class="rounded-xl bg-gray-800 ring-1 ring-white/10 shadow-2xl p-0 w-full max-w-lg backdrop:bg-black/60"
  >
    <form method="dialog" class="sr-only"><button>close</button></form>
    <div class="px-6 py-4 border-b border-white/10 flex items-center justify-between">
      <h3 class="text-base font-semibold text-white">Edit Product</h3>
      <button
        type="button"
        onclick="document.getElementById('dialog-edit').close()"
        class="rounded-md p-1.5 text-gray-400 hover:text-white hover:bg-white/10 transition-colors"
      >
        <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M6 18 18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </button>
    </div>
    <div class="px-6 py-4 space-y-4 overflow-y-auto max-h-[70vh]">
      <div>
        <label class="block text-xs font-medium text-gray-400 mb-1">Name</label>
        <input
          id="edit-name"
          type="text"
          value={product.name}
          class="w-full rounded-md bg-gray-900 border border-white/10 px-3 py-2 text-sm text-white placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-white/20"
        />
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-400 mb-1">Description</label>
        <textarea
          id="edit-description"
          rows={3}
          class="w-full rounded-md bg-gray-900 border border-white/10 px-3 py-2 text-sm text-white placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-white/20 resize-none"
        >{product.description ?? ''}</textarea>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-400 mb-1">Category</label>
        <select
          id="edit-category"
          class="w-full rounded-md bg-gray-900 border border-white/10 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-white/20"
        >
          {(['head', 'shaft', 'mesh', 'strings', 'service', 'upsell'] as const).map((cat) => (
            <option value={cat} selected={product.category === cat}>{CATEGORY_LABELS[cat]}</option>
          ))}
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-400 mb-1">Player Type</label>
        <select
          id="edit-playerType"
          class="w-full rounded-md bg-gray-900 border border-white/10 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-white/20"
        >
          <option value="" selected={!product.playerType}>— None —</option>
          <option value="boys" selected={product.playerType === 'boys'}>Boys</option>
          <option value="girls" selected={product.playerType === 'girls'}>Girls</option>
          <option value="goalies" selected={product.playerType === 'goalies'}>Goalies</option>
        </select>
      </div>
      <div>
        <label class="block text-xs font-medium text-gray-400 mb-1">Stock</label>
        <input
          id="edit-stock"
          type="number"
          min="0"
          value={product.stock}
          class="w-full rounded-md bg-gray-900 border border-white/10 px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-white/20"
        />
      </div>
      <div class="flex gap-6">
        <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
          <input id="edit-showInShop" type="checkbox" checked={product.showInShop === true} class="rounded border-white/20 bg-gray-900 text-indigo-600" />
          Show in Shop
        </label>
        <label class="flex items-center gap-2 text-sm text-gray-300 cursor-pointer">
          <input id="edit-showInBuilder" type="checkbox" checked={product.showInBuilder === true} class="rounded border-white/20 bg-gray-900 text-indigo-600" />
          Show in Builder
        </label>
      </div>
    </div>
    <div class="px-6 py-4 border-t border-white/10 flex justify-end gap-3">
      <button
        type="button"
        onclick="document.getElementById('dialog-edit').close()"
        class="rounded-md bg-white/5 px-4 py-2 text-sm font-medium text-gray-400 hover:text-white hover:bg-white/10 transition-colors"
      >
        Cancel
      </button>
      <button
        type="button"
        id="edit-submit-btn"
        onclick="submitEdit(this)"
        class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-medium text-white hover:bg-indigo-500 transition-colors disabled:opacity-50"
      >
        Save Changes
      </button>
    </div>
  </dialog>
</AdminLayout>

<script define:vars={{ productId: product._id, stripeProductId: product.stripeProductId ?? '' }}>
  async function submitEdit(btn) {
    const nameEl = document.getElementById('edit-name');
    const descEl = document.getElementById('edit-description');
    const catEl = document.getElementById('edit-category');
    const playerTypeEl = document.getElementById('edit-playerType');
    const stockEl = document.getElementById('edit-stock');
    const shopEl = document.getElementById('edit-showInShop');
    const builderEl = document.getElementById('edit-showInBuilder');

    btn.disabled = true;
    const original = btn.textContent;
    btn.textContent = 'Saving…';

    try {
      const res = await fetch('/api/admin/inventory/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          inventoryId: productId,
          stripeProductId,
          name: nameEl?.value || undefined,
          description: descEl?.value || undefined,
          category: catEl?.value || undefined,
          playerType: playerTypeEl?.value || undefined,
          stock: stockEl ? Number(stockEl.value) : undefined,
          showInShop: shopEl?.checked ?? false,
          showInBuilder: builderEl?.checked ?? false,
        }),
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Update failed');

      document.getElementById('dialog-edit')?.close();
      location.reload();
    } catch (err) {
      console.error(err);
      btn.disabled = false;
      btn.textContent = original;
      alert('Update failed: ' + (err.message || 'Unknown error'));
    }
  }

  async function confirmArchive(invId, stripeId, name) {
    if (!confirm(`Archive "${name}"? This will deactivate it in Stripe and remove it from Convex.`)) return;

    try {
      const res = await fetch('/api/admin/inventory/archive', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ inventoryId: invId, stripeProductId: stripeId }),
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Archive failed');

      window.location.href = '/admin/new/products';
    } catch (err) {
      console.error(err);
      alert('Archive failed: ' + (err.message || 'Unknown error'));
    }
  }

  window.submitEdit = submitEdit;
  window.confirmArchive = confirmArchive;
</script>
