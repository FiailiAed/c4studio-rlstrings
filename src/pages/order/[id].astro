---
import MainLayout from '../../layouts/MainLayout.astro';
import { getConvexClient } from '../../lib/convex';
import { api } from '../../../convex/_generated/api';

const { id } = Astro.params;
if (!id) return Astro.redirect('/404');

const convex = getConvexClient();

// Try to fetch by pickup code (4-digit string) - primary lookup
let order = await convex.query(api.orders.getOrderByPickupCode, {
  pickupCode: id
});

// Fallback: If not found by pickup code, try Convex _id (for backward compatibility)
// Convex IDs start with a letter and are long (e.g., "j7x8y9z...")
if (!order && id.startsWith('j') && id.length > 10) {
  order = await convex.query(api.orders.getOrderById, {
    orderId: id as any
  });
}

if (!order) return Astro.redirect('/404');

// Calculate progress steps
const progressSteps = [
  { step: 1, label: "Order Placed", active: true },
  { step: 2, label: "Pending Dropoff", active: order.status === "paid" && !order.droppedOffAt },
  { step: 3, label: "Dropped Off", active: order.status === "dropped_off" || !!order.droppedOffAt },
  { step: 4, label: "Admin Picked Up", active: ["in_progress", "ready_for_pickup", "completed"].includes(order.status) },
  { step: 5, label: "Stringing in Progress", active: ["in_progress", "ready_for_pickup", "completed"].includes(order.status) },
  { step: 6, label: "Stringing Complete", active: ["ready_for_pickup", "completed"].includes(order.status) },
  { step: 7, label: "Waiting at Stellar", active: ["ready_for_pickup", "completed"].includes(order.status) },
  { step: 8, label: "Customer Picked Up", active: order.status === "completed" },
  { step: 9, label: "Customer Review Left", active: false },
  { step: 10, label: "Order Complete", active: order.status === "completed" },
];

const currentStep = progressSteps.filter(s => s.active).length;
---

<MainLayout title={`Order ${order.pickupCode} - RL Strings`}>
  <div class="min-h-screen p-4 sm:p-8 relative">
    <!-- Background gradients -->
    <div class="fixed top-0 left-0 w-full h-full overflow-hidden -z-10">
      <div class="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-red-900/20 blur-[150px] rounded-full opacity-60"></div>
      <div class="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-red-800/10 blur-[150px] rounded-full opacity-40"></div>
    </div>

    <div class="max-w-4xl mx-auto">
      <!-- Header -->
      <h1 class="text-4xl font-bold text-white mb-8 text-center">
        Order Tracking
      </h1>

      <!-- Progress Indicator -->
      <div class="glass rounded-3xl p-8 mb-8">
        <div class="grid grid-cols-5 gap-2 mb-6">
          {progressSteps.map((step) => (
            <div class={`text-center ${step.active ? 'text-red-400' : 'text-neutral-500'}`}>
              <div class={`w-10 h-10 mx-auto rounded-full flex items-center justify-center mb-2 text-sm font-bold ${
                step.active ? 'bg-red-600 text-white' : 'bg-neutral-800'
              }`}>
                {step.step}
              </div>
              <p class="text-xs leading-tight">{step.label}</p>
            </div>
          ))}
        </div>

        <!-- Progress Bar -->
        <div class="w-full bg-neutral-800 h-3 rounded-full overflow-hidden">
          <div
            class="bg-red-600 h-3 rounded-full transition-all duration-500"
            style={`width: ${(currentStep / progressSteps.length) * 100}%`}
          />
        </div>
      </div>

      <!-- Order Receipt Card -->
      {order.stripeSessionId && (
        <div class="mb-8">
          <a
            href={`/order-success?session_id=${order.stripeSessionId}`}
            class="block glass rounded-3xl p-6 border border-neutral-800 hover:border-red-900/50 transition-all group overflow-hidden relative"
          >
            <div class="shimmer absolute inset-0 pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity"></div>
            <div class="flex items-center gap-4 relative z-10">
              <div class="bg-red-950/60 p-4 rounded-xl border border-red-800/60 group-hover:bg-red-900/60 transition-colors">
                <i data-lucide="receipt" class="w-6 h-6 text-red-500"></i>
              </div>
              <div class="flex-1">
                <h3 class="text-lg font-bold text-white mb-1 uppercase tracking-wide">View Order Receipt</h3>
                <p class="text-neutral-400 text-sm">Review your original order confirmation and payment details</p>
              </div>
              <div class="text-neutral-400 group-hover:text-red-500 transition-colors">
                <i data-lucide="arrow-right" class="w-5 h-5"></i>
              </div>
            </div>
          </a>
        </div>
      )}

      <!-- Order Details -->
      <div class="glass rounded-3xl p-8">
        <h2 class="text-2xl font-bold text-white mb-6">Order Information</h2>

        <div class="grid md:grid-cols-2 gap-6 text-white">
          <div>
            <p class="text-neutral-400 text-sm mb-1">Pickup Code</p>
            <p class="text-4xl font-bold text-red-500">{order.pickupCode}</p>
          </div>

          <div>
            <p class="text-neutral-400 text-sm mb-1">Customer Name</p>
            <p class="text-xl">{order.customerName}</p>
          </div>

          <div>
            <p class="text-neutral-400 text-sm mb-1">Email</p>
            <p class="text-xl break-all">{order.email}</p>
          </div>

          <div>
            <p class="text-neutral-400 text-sm mb-1">Order Type</p>
            <p class="text-xl capitalize">{order.orderType}</p>
          </div>

          <div class="md:col-span-2">
            <p class="text-neutral-400 text-sm mb-1">Item Description</p>
            <p class="text-xl">{order.itemDescription}</p>
          </div>

          {order.lineItems && order.lineItems.length > 0 && (
            <div class="md:col-span-2">
              <p class="text-neutral-400 text-sm mb-3">Order Details</p>
              <div class="bg-black/30 rounded-lg p-4">
                <table class="w-full text-sm">
                  <thead>
                    <tr class="border-b border-white/10">
                      <th class="text-left text-neutral-400 pb-2">Item</th>
                      <th class="text-right text-neutral-400 pb-2">Qty</th>
                      <th class="text-right text-neutral-400 pb-2">Price</th>
                      <th class="text-right text-neutral-400 pb-2">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {order.lineItems.map((item: any) => (
                      <tr class="border-b border-white/5">
                        <td class="py-2">
                          {item.productName}
                          <span class="text-xs text-neutral-500 ml-2 capitalize">({item.category})</span>
                        </td>
                        <td class="text-right">{item.quantity}</td>
                        <td class="text-right">${(item.unitAmount / 100).toFixed(2)}</td>
                        <td class="text-right font-semibold">${(item.totalAmount / 100).toFixed(2)}</td>
                      </tr>
                    ))}
                    <tr>
                      <td colspan="3" class="pt-3 text-right font-bold">Total:</td>
                      <td class="pt-3 text-right font-bold text-lg text-red-500">
                        ${(order.lineItems.reduce((sum: number, item: any) => sum + item.totalAmount, 0) / 100).toFixed(2)}
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          )}

          {order.droppedOffAt && (
            <div>
              <p class="text-neutral-400 text-sm mb-1">Dropped Off</p>
              <p class="text-lg">{new Date(order.droppedOffAt).toLocaleString()}</p>
            </div>
          )}

          {order.completedAt && (
            <div>
              <p class="text-neutral-400 text-sm mb-1">Completed</p>
              <p class="text-lg">{new Date(order.completedAt).toLocaleString()}</p>
            </div>
          )}
        </div>
      </div>
    </div>
  </div>

  <style>
    .glass {
      background: rgba(10, 10, 10, 0.8);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(220, 38, 38, 0.1), transparent);
      background-size: 200% 100%;
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
  </style>

  <script src="https://unpkg.com/lucide@latest"></script>
  <script is:inline>
    // @ts-ignore - lucide is loaded from CDN
    if (typeof lucide !== 'undefined') {
      lucide.createIcons();
    }
  </script>
</MainLayout>
