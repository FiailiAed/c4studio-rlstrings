---
import MainLayout from '../../layouts/MainLayout.astro';
import { ConvexHttpClient } from 'convex/browser';
import { api } from '../../../convex/_generated/api';
import DropOffConfirm from '../../components/DropOffConfirm.tsx';
import CustomerPickupConfirm from '../../components/CustomerPickupConfirm.tsx';
import OrderStatusStepper from '../../components/OrderStatusStepper.tsx';
import IslandLoader from '../../components/IslandLoader.astro';

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;

const { id } = Astro.params;
if (!id) return Astro.redirect('/order');

const client = new ConvexHttpClient(import.meta.env.PUBLIC_CONVEX_URL);
const order = await client.query(api.orders.getPublicOrderByPickupCode, { pickupCode: id });

if (!order) return Astro.redirect('/order?notfound=true');

function formatDate(ts: number | null): string {
  if (!ts) return '';
  return new Date(ts).toLocaleDateString('en-US', {
    month: 'long', day: 'numeric', year: 'numeric',
    hour: 'numeric', minute: '2-digit',
  });
}
---

<MainLayout
  title={`RL Strings | Order ${id}`}
  description="Check your order status."
>
  <section class="max-w-2xl mx-auto space-y-6 px-4 pb-28">

    <!-- Order Code Block with Collapsible Details -->
    <div class="bg-slate-900/50 backdrop-blur-sm border border-slate-700/50 rounded-xl p-6 text-center space-y-4">
      <p class="text-slate-400 text-xs uppercase tracking-widest">Your Unique Order Code</p>
      <p class="text-6xl font-mono font-black tracking-widest text-white">{order.pickupCode}</p>

      <details class="text-left">
        <summary class="text-slate-400 text-xs uppercase tracking-widest cursor-pointer hover:text-slate-300 transition-colors text-center">
          View Order Details
        </summary>
        <div class="mt-4 space-y-2">
          {order.lineItems && order.lineItems.length > 0 ? (
            <table class="w-full text-sm">
              <thead>
                <tr class="border-b border-slate-700/50 text-slate-400 text-xs uppercase">
                  <th class="text-left pb-2 font-semibold">Item</th>
                  <th class="text-center pb-2 font-semibold">Qty</th>
                  <th class="text-right pb-2 font-semibold">Price</th>
                  <th class="text-right pb-2 font-semibold">Total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-700/30">
                {order.lineItems.map((item) => (
                  <tr>
                    <td class="py-2 text-white">{item.productName}</td>
                    <td class="py-2 text-center text-slate-300">{item.quantity}</td>
                    <td class="py-2 text-right text-slate-300">${(item.unitAmount / 100).toFixed(2)}</td>
                    <td class="py-2 text-right text-white font-semibold">${(item.totalAmount / 100).toFixed(2)}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          ) : (
            <p class="text-slate-300">{order.itemDescription}</p>
          )}
        </div>
      </details>
    </div>

    <!-- Drop-Off Confirmation -->
    <IslandLoader>
      <DropOffConfirm client:load pickupCode={order.pickupCode} convexUrl={convexUrl} />
    </IslandLoader>

    <!-- Customer Pickup Confirmation -->
    <IslandLoader>
      <CustomerPickupConfirm client:load pickupCode={order.pickupCode} convexUrl={convexUrl} />
    </IslandLoader>

    <!-- Timestamps -->
    {(order.droppedOffAt || order.completedAt) && (
      <div class="bg-slate-900/50 backdrop-blur-sm border border-slate-700/50 rounded-xl p-6 space-y-2 text-sm">
        {order.droppedOffAt && (
          <div class="flex justify-between text-slate-300">
            <span class="text-slate-400">Dropped off</span>
            <span>{formatDate(order.droppedOffAt)}</span>
          </div>
        )}
        {order.pickedUpByCustomerAt && (
          <div class="flex justify-between text-slate-300">
            <span class="text-slate-400">Picked up</span>
            <span>{formatDate(order.pickedUpByCustomerAt)}</span>
          </div>
        )}
        {order.completedAt && (
          <div class="flex justify-between text-slate-300">
            <span class="text-slate-400">Completed</span>
            <span>{formatDate(order.completedAt)}</span>
          </div>
        )}
      </div>
    )}

    <!-- Footer link -->
    <div class="text-center pb-4">
      <a href="/order" class="text-slate-400 hover:text-white text-sm underline underline-offset-4 transition-colors">
        Check another order
      </a>
    </div>

  </section>

  <!-- Fixed Bottom Stepper -->
  <IslandLoader>
    <OrderStatusStepper client:load pickupCode={order.pickupCode} convexUrl={convexUrl} />
  </IslandLoader>
</MainLayout>
