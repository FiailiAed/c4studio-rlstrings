---
import BuilderLayout from '../../layouts/BuilderLayout.astro';
import BuilderWizard from '../../components/BuilderWizard';
import type { BuilderProduct } from '../../components/BuilderWizard';
import IslandLoader from '../../components/IslandLoader.astro';
import { ConvexHttpClient } from 'convex/browser';
import { api } from '../../../convex/_generated/api';

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;
const client = new ConvexHttpClient(convexUrl);
const builderItems = await client.query(api.inventory.getBuilderProducts, {});

const products: BuilderProduct[] = builderItems.map((item) => ({
  id: item._id,
  name: item.name,
  description: item.description ?? null,
  images: item.images ?? [],
  priceId: item.priceId ?? null,
  priceAmount: item.unitAmount ?? null,
  priceCurrency: item.currency ?? 'usd',
  priceType: item.priceType === 'recurring' ? 'recurring' : 'one_time',
  category: item.category ?? 'service',
  playerType: item.playerType ?? undefined,
}));
---

<BuilderLayout
  title="RL Strings | Pocket Builder"
  description="Stop settling for factory trash. Custom built, professionally strung."
>
  <section class="mb-8">
    <h1 class="text-3xl sm:text-4xl md:text-6xl font-black tracking-tighter mb-2 leading-[0.9] uppercase">
      Build Your <span class="text-transparent bg-clip-text bg-gradient-to-br from-red-500 to-red-700">Pocket.</span>
    </h1>
    <p class="text-sm text-neutral-400">Select your components step by step. Service is required.</p>
  </section>

  <IslandLoader>
    <BuilderWizard client:load products={products} convexUrl={convexUrl} />
  </IslandLoader>
</BuilderLayout>
