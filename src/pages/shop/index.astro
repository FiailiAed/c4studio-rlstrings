---
import MainLayout from '../../layouts/MainLayout.astro';
import type { ProductCardData } from '../../components/StripeShopCheckout';
import StripeShopCheckout from '../../components/StripeShopCheckout';
import IslandLoader from '../../components/IslandLoader.astro';
import { ConvexHttpClient } from 'convex/browser';
import { api } from '../../../convex/_generated/api';

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;
const client = new ConvexHttpClient(convexUrl);
const shopItems = await client.query(api.inventory.getShopProducts, {});

const products: ProductCardData[] = shopItems.map((item) => ({
  id: item._id,
  name: item.name,
  description: item.description ?? null,
  images: item.images ?? [],
  priceId: item.priceId ?? null,
  priceAmount: item.unitAmount ?? null,
  priceCurrency: item.currency ?? 'usd',
  priceType: item.priceType === 'recurring' ? 'recurring' : 'one_time',
}));
---

<MainLayout
  title="RL Strings | Shop"
  description="Stop settling for factory trash. Custom built, professionally strung."
>

<IslandLoader>
  <StripeShopCheckout client:load products={products} convexUrl={convexUrl} />
</IslandLoader>

</MainLayout>
