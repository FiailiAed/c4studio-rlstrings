---
export const prerender = true;

import ShopLayout from '../layouts/ShopLayout.astro';
import { ConvexHttpClient } from 'convex/browser';
import { api } from '../../convex/_generated/api';

const convexUrl = import.meta.env.PUBLIC_CONVEX_URL;
const client = new ConvexHttpClient(convexUrl);

const allProducts = await client.query(api.inventory.getBuilderProducts, {});

// Get head products with images for the carousel
const headImages = allProducts
  .filter((p) => (p.category ?? 'service') === 'head' && p.images && p.images.length > 0)
  .map((p) => ({ src: p.images![0], alt: p.name }))
  .slice(0, 6);

const imageCount = headImages.length;
const cycleDuration = imageCount * 4; // 4 seconds per image

// Compute CSS keyframe percentages for crossfade
// Each image fades in, holds, then fades out
function buildCarouselCSS(count: number, duration: number): string {
  if (count < 2) return '';
  const fadePercent = 100 / count;
  const holdEnd = fadePercent * 0.6;     // 60% of slot = visible
  const fadeOutEnd = fadePercent * 0.8;   // 80% of slot = fading out

  let keyframes = `@keyframes carousel-fade { `;
  keyframes += `0% { opacity: 1; } `;
  keyframes += `${holdEnd.toFixed(2)}% { opacity: 1; } `;
  keyframes += `${fadeOutEnd.toFixed(2)}% { opacity: 0; } `;
  keyframes += `${(100 - fadePercent * 0.2).toFixed(2)}% { opacity: 0; } `;
  keyframes += `100% { opacity: 1; } `;
  keyframes += `}`;

  let styles = keyframes + '\n';
  for (let i = 0; i < count; i++) {
    const delay = i * (duration / count);
    styles += `.carousel-img-${i} { animation: carousel-fade ${duration}s infinite; animation-delay: ${delay.toFixed(2)}s; opacity: ${i === 0 ? '1' : '0'}; }\n`;
  }
  return styles;
}

const carouselCSS = buildCarouselCSS(imageCount, cycleDuration);
---

<ShopLayout
  title="RL Strings | Custom Lacrosse Stringing"
  description="Expertly strung lacrosse pockets, custom built for your style of play. 100% satisfaction guarantee."
>
  <!-- ===== HERO: CSS-Only Image Carousel ===== -->
  <section class="relative w-full aspect-[4/3] md:aspect-[16/9] max-h-[70vh] overflow-hidden bg-gray-200">
    {imageCount === 0 && (
      <div class="absolute inset-0 bg-gray-100 flex items-center justify-center">
        <svg class="w-20 h-20 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
          <circle cx="8.5" cy="8.5" r="1.5" />
          <polyline points="21 15 16 10 5 21" />
        </svg>
      </div>
    )}
    {imageCount === 1 && (
      <img
        src={headImages[0].src}
        alt={headImages[0].alt}
        class="absolute inset-0 w-full h-full object-cover"
        loading="eager"
        width="1200"
        height="675"
      />
    )}
    {imageCount >= 2 && headImages.map((img, i) => (
      <img
        src={img.src}
        alt={img.alt}
        class={`absolute inset-0 w-full h-full object-cover carousel-img-${i}`}
        loading={i === 0 ? 'eager' : 'lazy'}
        width="1200"
        height="675"
      />
    ))}
    {/* Bottom gradient overlay for text legibility */}
    <div class="absolute inset-x-0 bottom-0 h-1/3 bg-gradient-to-t from-white/80 to-transparent"></div>
  </section>

  {imageCount >= 2 && <Fragment set:html={`<style>${carouselCSS}</style>`} />}

  <!-- ===== HEADLINE + PRIMARY CTA ===== -->
  <section class="max-w-3xl mx-auto px-4 py-16 text-center">
    <h1 class="text-4xl md:text-5xl font-black tracking-tight text-gray-900 mb-4">
      Transform Your Stick. Elevate Your Game.
    </h1>
    <p class="text-lg text-gray-600 mb-8 max-w-xl mx-auto">
      Expertly strung lacrosse pockets, custom built for your style of play.
    </p>
    <a
      href="/shop/new"
      class="inline-flex items-center gap-2 bg-black text-white px-8 py-4 rounded-lg font-bold text-lg hover:bg-gray-800 transition"
    >
      Build Your Pocket
      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="5" y1="12" x2="19" y2="12" />
        <polyline points="12 5 19 12 12 19" />
      </svg>
    </a>
    <div class="mt-6 flex items-center justify-center gap-2 text-sm text-gray-500">
      <svg class="w-5 h-5 text-green-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
        <polyline points="22 4 12 14.01 9 11.01" />
      </svg>
      100% Satisfaction Guarantee
    </div>
  </section>

  <!-- ===== VALUE PROPOSITION ===== -->
  <section class="bg-gray-50 py-16 px-4">
    <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
      {/* Left: Product Image */}
      <div>
        {headImages.length > 0 ? (
          <img
            src={headImages[0].src}
            alt={headImages[0].alt}
            class="w-full aspect-square object-cover rounded-xl border border-gray-200"
            loading="lazy"
            width="600"
            height="600"
          />
        ) : (
          <div class="w-full aspect-square bg-gray-100 rounded-xl border border-gray-200 flex items-center justify-center">
            <svg class="w-16 h-16 text-gray-300" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
              <circle cx="8.5" cy="8.5" r="1.5" />
              <polyline points="21 15 16 10 5 21" />
            </svg>
          </div>
        )}
      </div>

      {/* Right: Copy */}
      <div>
        <h2 class="text-3xl font-black text-gray-900 mb-6">
          Engineered for Your Style of Play
        </h2>
        <ul class="space-y-4">
          <li class="flex items-start gap-3">
            <svg class="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
              <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
            <span class="text-gray-700">Years of experience stringing for players at every level</span>
          </li>
          <li class="flex items-start gap-3">
            <svg class="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
              <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
            <span class="text-gray-700">Premium mesh, strings, and accessories from trusted brands</span>
          </li>
          <li class="flex items-start gap-3">
            <svg class="w-6 h-6 text-green-600 flex-shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
              <polyline points="22 4 12 14.01 9 11.01" />
            </svg>
            <span class="text-gray-700">Not happy? We'll restring it for free. No questions asked.</span>
          </li>
        </ul>
      </div>
    </div>
  </section>

  <!-- ===== TRUST STRIP: STATS ===== -->
  <section class="border-y border-gray-200 py-12 px-4">
    <div class="max-w-4xl mx-auto grid grid-cols-1 sm:grid-cols-3 gap-8 text-center">
      <div>
        <div class="text-3xl font-black text-gray-900">500+</div>
        <div class="text-sm text-gray-500 mt-1">Pockets Strung</div>
      </div>
      <div>
        <div class="text-3xl font-black text-gray-900">100%</div>
        <div class="text-sm text-gray-500 mt-1">Satisfaction Rate</div>
      </div>
      <div>
        <div class="text-3xl font-black text-gray-900">2-3 Day</div>
        <div class="text-sm text-gray-500 mt-1">Turnaround</div>
      </div>
    </div>
  </section>

  <!-- ===== HOW IT WORKS ===== -->
  <section class="max-w-5xl mx-auto px-4 py-16">
    <h2 class="text-3xl font-black text-center text-gray-900 mb-12">How It Works</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <div class="text-center">
        <div class="w-12 h-12 bg-black text-white rounded-full flex items-center justify-center mx-auto mb-4 text-xl font-bold">1</div>
        <h3 class="font-bold text-lg mb-2">Choose Your Setup</h3>
        <p class="text-gray-600 text-sm">Pick your service, head, mesh, strings, and pocket style through our builder.</p>
      </div>
      <div class="text-center">
        <div class="w-12 h-12 bg-black text-white rounded-full flex items-center justify-center mx-auto mb-4 text-xl font-bold">2</div>
        <h3 class="font-bold text-lg mb-2">We String It</h3>
        <p class="text-gray-600 text-sm">Your pocket is hand-strung with care and precision, typically within 2-3 business days.</p>
      </div>
      <div class="text-center">
        <div class="w-12 h-12 bg-black text-white rounded-full flex items-center justify-center mx-auto mb-4 text-xl font-bold">3</div>
        <h3 class="font-bold text-lg mb-2">Pick It Up</h3>
        <p class="text-gray-600 text-sm">Grab your stick at Stellar Athletics in Moorestown, NJ. You'll get a pickup code when it's ready.</p>
      </div>
    </div>
  </section>

  <!-- ===== FAQ ===== -->
  <section class="bg-gray-50 py-16 px-4">
    <div class="max-w-3xl mx-auto">
      <h2 class="text-3xl font-black text-center text-gray-900 mb-8">Frequently Asked Questions</h2>
      <div class="space-y-3">
        <details class="group bg-white rounded-xl border border-gray-200">
          <summary class="cursor-pointer p-5 font-medium flex items-center justify-between">
            How long does stringing take?
            <svg class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9" /></svg>
          </summary>
          <div class="px-5 pb-5 text-gray-600">
            Most orders are completed within 2-3 business days. Rush orders may be available — contact us for details.
          </div>
        </details>
        <details class="group bg-white rounded-xl border border-gray-200">
          <summary class="cursor-pointer p-5 font-medium flex items-center justify-between">
            Can I bring my own head?
            <svg class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9" /></svg>
          </summary>
          <div class="px-5 pb-5 text-gray-600">
            Absolutely! Select "I'm bringing my own head" in the builder and drop your head off at Stellar Athletics.
          </div>
        </details>
        <details class="group bg-white rounded-xl border border-gray-200">
          <summary class="cursor-pointer p-5 font-medium flex items-center justify-between">
            What's your guarantee?
            <svg class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9" /></svg>
          </summary>
          <div class="px-5 pb-5 text-gray-600">
            If your stick isn't performing exactly how you want it, we'll restring it for free. No questions asked.
          </div>
        </details>
        <details class="group bg-white rounded-xl border border-gray-200">
          <summary class="cursor-pointer p-5 font-medium flex items-center justify-between">
            Where do I pick up my order?
            <svg class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9" /></svg>
          </summary>
          <div class="px-5 pb-5 text-gray-600">
            All orders are picked up at Stellar Athletics — 876 North Lenola Road, Moorestown, New Jersey 08057. You'll receive a pickup code when your order is ready.
          </div>
        </details>
      </div>
    </div>
  </section>

  <!-- ===== FINAL CTA ===== -->
  <section class="max-w-3xl mx-auto px-4 py-16 text-center">
    <h2 class="text-3xl font-black text-gray-900 mb-4">Ready to Dial In Your Game?</h2>
    <a
      href="/shop/new"
      class="inline-flex items-center gap-2 bg-black text-white px-8 py-4 rounded-lg font-bold text-lg hover:bg-gray-800 transition"
    >
      Start Your Build
      <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="5" y1="12" x2="19" y2="12" />
        <polyline points="12 5 19 12 12 19" />
      </svg>
    </a>
  </section>
</ShopLayout>
